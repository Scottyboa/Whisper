const backendUrl = "https://173801d2-a106-4f61-b01b-87d88f51476a-00-2plr1pm7anr7k.worf.replit.dev"; // Your actual Replit backend URL

let sessionId = "";

document.getElementById("recordButton").addEventListener("click", () => {
    sessionId = "";
    document.getElementById("transcription").innerText = "";
});

document.getElementById("uploadButton").addEventListener("click", async () => {
    const fileInput = document.getElementById("audioFile");
    if (fileInput.files.length === 0) {
        alert("Please select an audio file first.");
        return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    try {
        const response = await fetch(`${backendUrl}/upload`, {
            method: "POST",
            body: formData
        });

        const result = await response.json();
        if (result.session_id) {
            sessionId = result.session_id;
            alert("File uploaded successfully!");
        } else {
            alert("Upload error: " + (result.error || "Unknown error"));
        }
    } catch (error) {
        alert("Error uploading file: " + error);
    }
});

document.getElementById("transcribeButton").addEventListener("click", async () => {
    const apiKey = localStorage.getItem("openai_api_key");
    if (!apiKey) {
        alert("API key is missing. Please enter your API key on the login page.");
        return;
    }
    if (!sessionId) {
        alert("No recording found. Please record and stop first.");
        return;
    }

    try {
        const response = await fetch(`${backendUrl}/transcribe`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ api_key: apiKey, session_id: sessionId })
        });

        const result = await response.json();
        if (result.transcription) {
            document.getElementById("transcription").innerText = result.transcription;
        } else {
            alert("Transcription error: " + (result.error || "Unknown error"));
        }
    } catch (error) {
        alert("Error during transcription: " + error);
    }
});

document.getElementById("deleteButton").addEventListener("click", async () => {
    try {
        const response = await fetch(`${backendUrl}/delete`, { method: "DELETE" });
        const result = await response.json();
        alert(result.message || result.error);
        sessionId = "";
    } catch (error) {
        alert("Error deleting recording: " + error);
    }
});
